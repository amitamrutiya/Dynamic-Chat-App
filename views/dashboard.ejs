<%- include('layouts/header.ejs')%>

<h2 class="mb-4">Hii, <%= user.name %></h2>

<div class="row">
  <div class="col-md-3">
    <ul class="list-group">
      <% if(users.length>0){ for (let i = 0; i < users.length; i++) { %>
      <li
        class="list-group-item list-group-item-dark cursor-pointer user-list"
        data-id="<%= users[i]['_id'] %>"
      >
        <img
          src="<%= 'http://localhost:' + port + '/' + users[i]['image'] %>"
          alt=""
          width="50px"
          height="50px"
        />
        <%= users[i]['name'] %> <% if(users[i]['is_online']){ %>
        <span class="badge badge-success" id="<%= users[i]['_id'] %>-status"
          >Online</span
        >
        <% } else{ %>
        <span class="badge badge-danger" id="<%= users[i]['_id'] %>-status"
          >Offline</span
        >
        <% } %>
      </li>
      <% } } else{ %>
      <li class="list-group-item list-group-item-dark">No Users</li>
      <% } %>
    </ul>
  </div>
  <div class="col-md-9">
    <h3 class="start-head">Click to Start the Chat</h3>
    <div class="chat-section">
      <div id="chat-container"></div>

      <form action="save-chat" method="post" id="chat-form">
        <input
          class="border"
          type="text"
          name="message"
          placeholder="Enter message"
          id="message"
          required
        />
        <input type="submit" value="Send Message" class="btn btn-primary" />
      </form>
    </div>
  </div>
</div>

<script>
  var sender_id = "<%= user._id %>";
  var receiver_id = "";
  var socket = io("/user-namespace", {
    auth: {
      token: "<%= user._id %>",
      name: "<%= user.name %>",
    },
  });

  $(document).ready(function () {
    $(".user-list").click(function () {
      var userId = $(this).attr("data-id");
      receiver_id = userId;
      $(".start-head").hide();
      $(".chat-section").show();
    });
  });

  //update user status
  socket.on("getOnlineUser", function (data) {
    $(`#${data.user_id}-status`)
      .removeClass("badge-danger")
      .addClass("badge-success")
      .text("Online");
  });

  socket.on("getOfflineUser", function (data) {
    $(`#${data.user_id}-status`)
      .removeClass("badge-success")
      .addClass("badge-danger")
      .text("Offline");
  });

  //chat save of user
  $("#chat-form").submit(function (e) {
    e.preventDefault();
    var message = $("#message").val();
    if (message) {
      $.ajax({
        url: "/save-chat",
        type: "POST",
        data: {
          sender_id: sender_id,
          receiver_id: receiver_id,
          message: message,
        },

        success: function (response) {
          if (response.success) {
            $("#message").val("");
            let chat = response.data.message;
            let html =
              `
            <div class="current-user-chat">
              <h5>` +
              chat +
              `</h5>
            </div>
            `;
            $("#chat-container").append(html);
            socket.emit("newChat", response.data);
          } else {
            alert(response.message);
          }
        },
      });
    }
  });

  socket.on("loadNewChat", function (data) {
    if (sender_id === data.receiver_id || receiver_id === data.sender_id) {
      let chat = data.message;
      let html =
        `
    <div class="other-user-chat">
      <h5>` +
        chat +
        `</h5>
    </div>
    `;
      $("#chat-container").append(html);
    }
  });
</script>

<%- include('layouts/footer.ejs')%>
